<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>토스페이먼츠 샘플 프로젝트</title>
    <!-- SDK 추가 -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>

<body>
<div class="wrapper">
    <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
        <h1>일반 결제</h1>
        <div id="payment-method" style="display: flex">
            <button id="CARD" class="button2" onclick="selectPaymentMethod('CARD')">카드</button>
        </div>
        <button class="button" style="margin-top: 30px" onclick="requestPayment()">결제하기</button>
    </div>
</div>
<script>
    const amount = {
        currency: "KRW",
        value: 50000, // 결제 금액
    };

    let selectedPaymentMethod = null;

    function selectPaymentMethod(method) {
        if (selectedPaymentMethod != null) {
            document.getElementById(selectedPaymentMethod).style.backgroundColor = "#ffffff";
        }
        selectedPaymentMethod = method;
        document.getElementById(selectedPaymentMethod).style.backgroundColor = "rgb(229 239 255)";
    }

    // const clientKey = 받아온 값 넣기
    const customerKey = generateRandomString();
    const tossPayments = TossPayments(clientKey);
    const payment = tossPayments.payment({
        customerKey,
    });

    async function requestPayment() {
        if (selectedPaymentMethod === "CARD") {
            const orderId = generateRandomString(); // 고유 주문 ID 생성

            try {
                // Step 1: 서버에 결제 금액과 orderId를 임시 저장
                const saveResponse = await fetch("/api/payment/saveAmount", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        orderId,
                        amount: amount.value.toString(), // 세션 저장을 위해 문자열로 변환
                    }),
                });

                if (!saveResponse.ok) {
                    alert("결제 금액 저장 실패: 서버 오류");
                    return;
                }

                // Step 2: 결제 금액 검증
                const verifyResponse = await fetch("/api/payment/verifyAmount", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        orderId,
                        amount: amount.value.toString(),
                    }),
                });

                if (!verifyResponse.ok) {
                    const errorData = await verifyResponse.json();
                    alert(`금액 검증 실패: ${errorData.message}`);
                    return;
                }

                // Step 3: 토스페이먼츠에 결제 요청
                await payment.requestPayment({
                    method: "CARD",
                    amount,
                    orderId, // 서버에 저장한 주문 ID
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success",
                    failUrl: window.location.origin + "/fail",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    card: {
                        useEscrow: false,
                        flowMode: "DEFAULT",
                        useCardPoint: false,
                        useAppCardOnly: false,
                    },
                });
            } catch (error) {
                console.error("결제 요청 중 오류가 발생했습니다.", error);
                alert("결제 요청 중 오류가 발생했습니다. 다시 시도해주세요.");
            }
        } else {
            alert("결제 방식을 선택해주세요.");
        }
    }

    function generateRandomString() {
        return window.btoa(Math.random()).slice(0, 20); // 고유 ID 생성
    }
</script>

</body>
</html>
