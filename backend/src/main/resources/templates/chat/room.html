<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1:1 채팅</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
    }

    .token-form {
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
    }

    .token-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .token-form button {
      width: 100%;
      padding: 10px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .token-form button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .chat-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      height: 70vh;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      width: 100%; /* 전체 너비 사용 */
    }

    .sent {
      justify-content: flex-end;
    }

    .received {
      justify-content: flex-start;
    }

    .message-content {
      position: relative;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
      max-width: 70%;
    }

    .message-status {
      position: absolute;
      bottom: 2px;
      right: 5px;
      font-size: 0.7em;
      color: #666;
    }

    .sent .message-status {
      color: rgba(255, 255, 255, 0.7); /* 보낸 메시지의 경우 밝은 색상 */
    }

    .received .message-content {
      background-color: #f1f0f0;
      align-self: flex-start;
    }

    .sent .message-content {
      background-color: #0084ff;
      color: white;
      align-self: flex-end;
    }

    .chat-input {
      display: flex;
      padding: 20px;
      border-top: 1px solid #ddd;
      background-color: #fff;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }

    .chat-input button {
      padding: 10px 20px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .chat-input button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 토큰 입력 폼 -->
  <div class="token-form" id="tokenForm">
    <input type="text" id="accessToken" placeholder="Access Token을 입력하세요...">
    <input type="number" id="userId" placeholder="사용자 ID를 입력하세요...">
    <button onclick="submitToken()" id="tokenSubmitButton">토큰 제출</button>
  </div>

  <!-- 채팅 컨테이너 -->
  <div class="chat-container hidden" id="chatContainer">
    <div class="chat-messages" id="messageArea"></div>
    <div class="chat-input">
      <input type="text" id="message" placeholder="메시지를 입력하세요...">
      <button onclick="sendMessage()" id="sendButton" disabled>전송</button>
    </div>
  </div>
</div>

<script>
  const roomId = '[[${roomId}]]';
  let stompClient = null;
  let currentUserId = null;

  function submitToken() {
    const tokenInput = document.getElementById('accessToken');
    const userIdInput = document.getElementById('userId');
    const token = tokenInput.value.trim();
    const userId = userIdInput.value.trim();

    if (!token) {
      alert('토큰을 입력해주세요.');
      return;
    }

    if (!userId) {
      alert('사용자 ID를 입력해주세요.');
      return;
    }

    // 토큰을 sessionStorage에 저장 (보안상 sessionStorage 사용)
    sessionStorage.setItem('accessToken', token);
    currentUserId = parseInt(userId); // 전역 변수 currentUserId 업데이트

    // 폼 숨기고 채팅창 표시
    document.getElementById('tokenForm').classList.add('hidden');
    document.getElementById('chatContainer').classList.remove('hidden');

    loadAllMessages();

    // 웹소켓 연결 시작
    connect();
  }

  function connect() {
    const socket = new SockJS("/ws-stomp");
    stompClient = Stomp.over(socket);

    const token = sessionStorage.getItem('accessToken');
    const headers = {
      'Authorization': `Bearer ${token}`,  // CONNECT 시에도 토큰을 포함
      'room-id': roomId
    };

    stompClient.connect(headers, function(frame) {  // headers를 첫 번째 인자로 전달
      console.log('Connected: ' + frame);

      stompClient.subscribe(`/sub/chat-rooms/${roomId}/messages`, function(message) {
        showMessage(JSON.parse(message.body));
      });

      stompClient.subscribe(`/sub/chat-rooms/${roomId}/read`, function(message) {
        const jsonBody = JSON.parse(message.body);
        const readMessages = jsonBody.messages;
        // currentUserId = jsonBody.userId;

        // 메시지 영역의 모든 내용을 지웁니다
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = '';

        // 새로 받은 메시지들을 다시 표시
        readMessages.forEach(readMessage => {
          showMessage(readMessage);
        });
      });

      stompClient.subscribe('/user/queue/errors', function(message) {
      });

      sendJoinMessage()

      document.getElementById('sendButton').disabled = false;
    }, function(error) {
      console.error('STOMP error:', error);
      if(error.includes('Invalid authentication token')) {
        alert('인증에 실패했습니다. 토큰을 확인해주세요.');
        document.getElementById('tokenForm').classList.remove('hidden');
        document.getElementById('chatContainer').classList.add('hidden');
        sessionStorage.removeItem('accessToken');
      }
    });
  }

  function disconnect() {
    if (stompClient != null) {
      stompClient.disconnect(function() {
        console.log("Disconnected");
      });
    }
  }

  function loadAllMessages() {
    fetch(`/chat-rooms/${roomId}/messages`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
      }
    })
            .then(response => response.json())
            .then(messages => {
              // 메시지 로딩 후 화면에 표시
              messages.forEach(message => {
                showMessage(message);
              });
            })
            .catch(error => {
              console.error("Error loading messages:", error);
            });
  }

  function sendJoinMessage() {
    const token = sessionStorage.getItem('accessToken');
    const headers = {
      'Authorization': `Bearer ${token}`
    };
    stompClient.send("/pub/message", headers, JSON.stringify({
      'type': 'JOIN',
      'roomId': roomId
    }));
  }

  function sendMessage() {
    const messageInput = document.getElementById('message');
    const messageContent = messageInput.value.trim();

    if (messageContent && stompClient) {
      const token = sessionStorage.getItem('accessToken');
      const headers = {
        'Authorization': `Bearer ${token}`
      };

      const chatMessage = {
        'type': 'TALK',
        'roomId': roomId,
        'content': messageContent
      };

      stompClient.send("/pub/message", headers, JSON.stringify(chatMessage));
      messageInput.value = '';
    }
  }

  function showMessage(message) {
    const messageArea = document.getElementById('messageArea');
    const messageDiv = document.createElement('div');

    switch(message.type) {
      case 'TALK':
        const isMyMessage = message.senderId === currentUserId;
        messageDiv.className = `message ${isMyMessage ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
                <div class="message-content">
                    ${message.content}
                    <span class="message-status ${isMyMessage ? '' : 'hidden'}">
                        ${message.read ? '읽음' : '안읽음'}
                    </span>
                </div>`;
        break;
    }

    messageArea.appendChild(messageDiv);
    messageArea.scrollTop = messageArea.scrollHeight;
  }

  // Enter 키 이벤트
  document.getElementById('message').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  document.getElementById('accessToken').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      submitToken();
    }
  });

  document.getElementById('userId').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      submitToken();
    }
  });

  // 페이지 언로드 시 연결 해제
  window.onbeforeunload = function() {
    disconnect();
  };
</script>
</body>
</html>