<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Chat Application</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket Chat</h2>

<!-- 사용자 ID와 채팅방 ID 입력 -->
<div>
  <label for="senderId">User ID: </label>
  <input type="number" id="senderId" placeholder="Enter your user ID" required />
</div>

<div>
  <label for="chatRoomId">Chat Room ID: </label>
  <input type="number" id="chatRoomId" placeholder="Enter chat room ID" required />
</div>

<!-- JWT 토큰 입력 -->
<div>
  <label for="authToken">Authorization Token: </label>
  <input type="text" id="authToken" placeholder="Enter your JWT token" required />
</div>

<!-- 채팅방 -->
<div id="chatRoom" style="display: none;">
  <h3>Chat Room</h3>
  <div id="messages"></div>

  <!-- 메시지 입력창 추가 -->
  <div>
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script th:inline="javascript">
  let stompClient = null;

  // 웹소켓 연결
  function connect() {
    const senderId = document.getElementById('senderId').value;
    const chatRoomId = document.getElementById('chatRoomId').value;
    const authToken = document.getElementById('authToken').value; // JWT 토큰 가져오기

    if (!senderId || !chatRoomId || !authToken) {
      alert('Please enter User ID, Chat Room ID, and JWT Token');
      return;
    }

    const socket = new SockJS('/ws/chat'); // 웹소켓 서버 엔드포인트
    stompClient = Stomp.over(socket);

    const headers = {
      'Authorization': 'Bearer ' + authToken // Authorization 헤더 추가
    };

    stompClient.connect(headers, function (frame) {
      console.log('Connected: ' + frame);

      // 연결이 되었을 때, 채팅방에 ENTER 메시지를 전송
      const enterMessage = {
        type: 'ENTER',
        chatRoomId: chatRoomId,
        senderId: senderId,
        message: `${senderId} has entered the room` // 입장 메시지
      };

      stompClient.send(`/app/chat/${chatRoomId}/send`, {}, JSON.stringify(enterMessage)); // 서버로 입장 메시지 전송

      // 채팅 메시지 구독
      stompClient.subscribe(`/topic/chat/${chatRoomId}`, function (messageOutput) {
        showMessage(JSON.parse(messageOutput.body));
      });

      // 채팅방을 보이게 하기
      document.getElementById('chatRoom').style.display = 'block';
    });
  }

  // 메시지 보내기
  function sendMessage() {
    const message = document.getElementById('messageInput').value;
    const senderId = document.getElementById('senderId').value;
    const chatRoomId = document.getElementById('chatRoomId').value;

    if (!senderId || !chatRoomId) {
      alert('Please enter both User ID and Chat Room ID');
      return;
    }

    if (message && stompClient) {
      const chatMessage = {
        type: 'TALK',
        chatRoomId: chatRoomId,
        senderId: senderId,
        message: message
      };

      stompClient.send(`/app/chat/${chatRoomId}/send`, {}, JSON.stringify(chatMessage));
      document.getElementById('messageInput').value = ''; // 메시지 입력창 비우기
    }
  }

  // 메시지 화면에 표시
  function showMessage(message) {
    const messagesDiv = document.getElementById('messages');
    const messageElement = document.createElement('div');
    messageElement.innerHTML = `${message.senderId}: ${message.message}`;
    messagesDiv.appendChild(messageElement);
  }

  // 페이지 로드 시 웹소켓 연결
  window.onload = function() {
    // 웹소켓 연결은 사용자와 채팅방 ID가 입력되었을 때만 시도
    document.getElementById('senderId').addEventListener('change', connect);
    document.getElementById('chatRoomId').addEventListener('change', connect);
    document.getElementById('authToken').addEventListener('change', connect);

    // 연결 버튼을 눌렀을 때 연결 시도
    document.getElementById('connectButton').addEventListener('click', connect);
  };
</script>

<!-- 연결 버튼 -->
<button id="connectButton">Connect</button>

</body>
</html>
